<!DOCTYPE html>
<html>
<head>
  <title>Shark Tank Recap Display</title>
</head>
<body>
  <div id="fetched-content">
    <p>Loading content...</p>
  </div>

  <script>
    // Get "name" parameter from URL; default to "Chocomize"
    const nameParam = new URLSearchParams(window.location.search).get('name') || 'Chocomize';

    // Fetch Updates.json to set the document title and return the base URL.
    const setPageTitleAndBase = async () => {
      try {
        const res = await fetch('Updates.json');
        const data = await res.json();
        document.title = data[nameParam]?.title || document.title;
        return data[nameParam]?.recap?.recapLink;
      } catch (error) {
        console.error('Error fetching Updates.json:', error);
        return null;
      }
    };

    // Process the fetched HTML: remove unwanted elements and fix image sources.
    const processContent = () => {
      const container = document.getElementById('fetched-content');
      if (!container) return;
      
      // Remove all divs with class "lasso-container"
      container.querySelectorAll('div.lasso-container').forEach(div => div.remove());
      
      // Replace <p> content with its <noscript> content (if any)
      container.querySelectorAll('p').forEach(p => {
        const ns = p.querySelector('noscript');
        if (ns?.innerHTML) p.innerHTML = ns.innerHTML;
      });
      
      // Remove all <iframe> elements.
      container.querySelectorAll('iframe').forEach(iframe => iframe.remove());
      
      // Remove any <noscript> that contains an <iframe>.
      container.querySelectorAll('noscript').forEach(ns => {
        const temp = document.createElement('div');
        temp.innerHTML = ns.innerHTML;
        if (temp.querySelector('iframe')) ns.remove();
      });
      
      // Update image sources: remove any prefix before 'https://sharktankrecap.com/'.
      container.querySelectorAll('img').forEach(img => {
        const src = img.getAttribute('src');
        const target = 'https://sharktankrecap.com/';
        const idx = src.indexOf(target);
        if (idx > 0) img.setAttribute('src', src.substring(idx));
      });
    };

    // Fetch remote HTML from the Netlify function and insert it into the page.
    const fetchAndDisplayHTML = async () => {
      try {
        const funcUrl = `/.netlify/functions/fetch?name=${encodeURIComponent(nameParam)}`;
        const res = await fetch(funcUrl);
        const html = await res.text();
        const container = document.getElementById('fetched-content');
        if (container) {
          container.innerHTML = html;
          processContent();
        } else {
          console.error("Container element not found.");
        }
      } catch (error) {
        console.error('Error fetching HTML:', error);
      }
    };

    // Initialization: set title/baseUrl then fetch and display the HTML content.
    const init = async () => {
      const baseUrl = await setPageTitleAndBase();
      await fetchAndDisplayHTML();
      return baseUrl;
    };

    // Call init and then update all anchor elements with rel="home" directly.
    init().then((baseUrl) => {
      if (baseUrl) {
        document.querySelectorAll('a[rel="home"]').forEach(anchor => {
          anchor.href = baseUrl;
        });
      }
    });
  </script>
</body>
</html>