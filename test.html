<!DOCTYPE html>
<html>
<head>
  <title>Shark Tank Recap Display</title>
</head>
<body>
  <script>
    // Get "link" parameter from URL
    const recapLink = new URLSearchParams(window.location.search).get('link');

    if (!recapLink) {
      document.body.innerHTML = '<h2>Missing "link" parameter in URL.</h2>';
      throw new Error('Missing "link" parameter');
    }

    // Global variable for document title update
    let newTitle = null;

    const processContent = () => {
      if (newTitle !== null) {
        document.title = newTitle;
      }

      const container = document.body;

      container.querySelectorAll('div.lasso-container').forEach(div => div.remove());

      const getSrcFromAttributes = (img) => {
        const srcset = img.getAttribute('srcset');
        const dataSrc = img.getAttribute('data-src');
        const dataLazySrc = img.getAttribute('data-lazy-src');
        if (srcset) return srcset.split(',')[0].trim().split(' ')[0];
        if (dataSrc) return dataSrc;
        if (dataLazySrc) return dataLazySrc;
        return null;
      };

      container.querySelectorAll('img').forEach(img => {
        let src = img.getAttribute('src');
        if (src && src.startsWith('data:image')) {
          const newSrc = getSrcFromAttributes(img);
          if (newSrc) img.setAttribute('src', newSrc);
          src = newSrc;
        }
        const target = 'https://sharktankrecap.com/';
        const idx = src?.indexOf(target);
        if (idx > 0) img.setAttribute('src', src.substring(idx));
      });

      container.querySelectorAll('a[rel="home"]').forEach(anchor => {
        anchor.href = recapLink;
      });
      const comp = document.querySelector('a[rel="tag"]');
      if (comp) {
        comp.href = recapLink;
      }

      container.querySelectorAll('a[rel="tag"]').forEach(anchor => {
        const match = anchor.textContent.match(/^SEASON\s+(\d{1,2})/i);
        if (match) {
          anchor.href = "S" + match[1] + ".html";
        }
      });

      container.querySelectorAll('iframe').forEach(iframe => {
        const iframeSrc = iframe.getAttribute('src');
        if (!iframeSrc || !iframeSrc.startsWith('https://www.youtube.com')) {
          iframe.remove();
        }
      });
    };

    const fetchAndReplaceHTML = async () => {
      try {
        const funcUrl = `/.netlify/functions/fetch?link=${encodeURIComponent(recapLink)}`;
        const res = await fetch(funcUrl);
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        const html = await res.text();
        const parser = new DOMParser();
        const newDoc = parser.parseFromString(html, 'text/html');
        document.replaceChild(newDoc.documentElement, document.documentElement);
        processContent();
      } catch (error) {
        console.error('Error fetching HTML:', error);
        document.body.innerHTML = '<h2>Error loading content. Please try again later.</h2>';
      }
    };

    fetchAndReplaceHTML();
  </script>
</body>
</html>