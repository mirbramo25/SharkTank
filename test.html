<!DOCTYPE html>
<html>
<head>
  <title>Shark Tank Recap Display</title>
</head>
<body>
  <div id="fetched-content">
    <p>Loading content...</p>
  </div>

  <script>
    // Global variable to store the base URL
    let baseUrl = null;

    // Get "name" parameter from URL; default to "Chocomize"
    const nameParam = new URLSearchParams(window.location.search).get('name') || 'Chocomize';

    // Fetch Updates.json to set the document title and baseUrl
    const setPageTitleAndBase = async () => {
      try {
        const res = await fetch('Updates.json');
        const data = await res.json();
        document.title = data[nameParam]?.title || document.title;
        baseUrl = data[nameParam]?.recap?.recapLink || null;
      } catch (error) {
        console.error('Error fetching Updates.json:', error);
      }
    };

    // Process the fetched HTML: remove unwanted elements, fix image sources, and update anchor hrefs
    const processContent = () => {
  const container = document.getElementById('fetched-content');
  if (!container) return;

  // Remove all divs with class "lasso-container"
  container.querySelectorAll('div.lasso-container').forEach(div => div.remove());

  // Replace <noscript> content with its parsed HTML content
  container.querySelectorAll('noscript').forEach(ns => {
    const temp = document.createElement('div');
    temp.innerHTML = ns.innerHTML;
    ns.replaceWith(...temp.childNodes);
  });

  // Remove all <iframe> elements
  container.querySelectorAll('iframe').forEach(iframe => iframe.remove());

  // Update <img> elements
  container.querySelectorAll('img').forEach(img => {
    // Retrieve the current src attribute
    let src = img.getAttribute('src');

    // Check if src starts with 'data:image'
    if (src && src.startsWith('data:image')) {
      const srcset = img.getAttribute('srcset');
      if (srcset) {
        // Extract the first URL from the srcset
        const firstSrcsetUrl = srcset.split(',')[0].trim().split(' ')[0];
        img.setAttribute('src', firstSrcsetUrl);
        // Update the src variable to the new value
        src = firstSrcsetUrl;
      }
    }

    // Apply existing logic to adjust the src
    const target = 'https://sharktankrecap.com/';
    const idx = src.indexOf(target);
    if (idx > 0) {
      img.setAttribute('src', src.substring(idx));
    }
  });

  // Update all anchor elements with rel="home" to have href as baseUrl
  if (baseUrl) {
    container.querySelectorAll('a[rel="home"]').forEach(anchor => {
      anchor.href = baseUrl;
    });
  }
};

    // Fetch remote HTML from the Netlify function and insert it into the page
    const fetchAndDisplayHTML = async () => {
      try {
        const funcUrl = `/.netlify/functions/fetch?name=${encodeURIComponent(nameParam)}`;
        const res = await fetch(funcUrl);
        const html = await res.text();
        const container = document.getElementById('fetched-content');
        if (container) {
          container.innerHTML = html;
          processContent();
        } else {
          console.error("Container element not found.");
        }
      } catch (error) {
        console.error('Error fetching HTML:', error);
      }
    };

    // Initialization: set title and baseUrl, then fetch and display the HTML content
    const init = async () => {
      await setPageTitleAndBase();
      await fetchAndDisplayHTML();
    };

    // Call init to start the process
    init();
  </script>
</body>
</html>